# ğŸ›¡ï¸ åˆ¤é¢˜ç³»ç»Ÿå®‰å…¨æ²™ç®±æŒ‡å—

## ğŸ“Š **å½“å‰å®‰å…¨çŠ¶å†µ**

### âœ… **å·²å®ç°çš„å®‰å…¨æ²™ç®±**

1. **Dockerå®¹å™¨éš”ç¦»**
   - âœ… å®Œæ•´çš„Docker judgeré•œåƒ
   - âœ… éç‰¹æƒç”¨æˆ·æ‰§è¡Œ
   - âœ… ç½‘ç»œéš”ç¦»ï¼ˆnetwork_mode: noneï¼‰
   - âœ… åªè¯»æ–‡ä»¶ç³»ç»Ÿ
   - âœ… èµ„æºé™åˆ¶ï¼ˆCPUã€å†…å­˜ã€æ–‡ä»¶å¤§å°ï¼‰

2. **è¿›ç¨‹çº§æ²™ç®±**
   - âœ… èµ„æºé™åˆ¶ï¼ˆCPUæ—¶é—´ã€å†…å­˜ã€æ–‡ä»¶æè¿°ç¬¦ï¼‰
   - âœ… è¿›ç¨‹éš”ç¦»
   - âœ… å®‰å…¨è¿›ç¨‹ç»„ç®¡ç†

3. **å¼•æ“å·¥å‚æ¨¡å¼**
   - âœ… è‡ªåŠ¨é€‰æ‹©æœ€ä½³å¼•æ“
   - âœ… æ”¯æŒå¤šç§åˆ¤é¢˜å¼•æ“
   - âœ… ç¯å¢ƒæ£€æµ‹å’Œå›é€€æœºåˆ¶

## ğŸ”§ **å®‰å…¨é…ç½®è¯´æ˜**

### **1. Dockerå®‰å…¨æ²™ç®±**

**ç‰¹ç‚¹ï¼š**
- ğŸ›¡ï¸ **å®¹å™¨éš”ç¦»** - å®Œå…¨éš”ç¦»çš„æ‰§è¡Œç¯å¢ƒ
- ğŸ”’ **éç‰¹æƒç”¨æˆ·** - ä½¿ç”¨nobodyç”¨æˆ·æ‰§è¡Œ
- ğŸŒ **ç½‘ç»œéš”ç¦»** - ç¦ç”¨ç½‘ç»œè®¿é—®
- ğŸ“ **æ–‡ä»¶ç³»ç»Ÿä¿æŠ¤** - åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ
- âš¡ **èµ„æºé™åˆ¶** - CPUã€å†…å­˜ã€æ–‡ä»¶å¤§å°é™åˆ¶

**é…ç½®ï¼š**
```python
# åœ¨docker.envä¸­è®¾ç½®
JUDGE_ENGINE=docker
SANDBOX_ENABLED=True
```

### **2. è¿›ç¨‹çº§æ²™ç®±**

**ç‰¹ç‚¹ï¼š**
- ğŸ”’ **èµ„æºé™åˆ¶** - ä½¿ç”¨resourceæ¨¡å—é™åˆ¶èµ„æº
- ğŸš« **ç³»ç»Ÿè°ƒç”¨é™åˆ¶** - é™åˆ¶å±é™©ç³»ç»Ÿè°ƒç”¨
- â±ï¸ **è¶…æ—¶æ§åˆ¶** - ä¸¥æ ¼çš„æ‰§è¡Œæ—¶é—´é™åˆ¶
- ğŸ’¾ **å†…å­˜æ§åˆ¶** - å†…å­˜ä½¿ç”¨é‡ç›‘æ§

**é…ç½®ï¼š**
```python
# åœ¨docker.envä¸­è®¾ç½®
JUDGE_ENGINE=sandbox
SANDBOX_ENABLED=True
```

### **3. åŸºç¡€å¼•æ“ï¼ˆå¼€å‘ç¯å¢ƒï¼‰**

**ç‰¹ç‚¹ï¼š**
- âš ï¸ **ä»…é™å¼€å‘** - ä¸æ¨èç”Ÿäº§ç¯å¢ƒä½¿ç”¨
- ğŸ”§ **ç®€å•å®ç°** - åŸºæœ¬çš„è¿›ç¨‹ç®¡ç†
- ğŸš¨ **å®‰å…¨é£é™©** - ç¼ºä¹å®Œæ•´éš”ç¦»

## ğŸš€ **éƒ¨ç½²é…ç½®**

### **ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èDockerï¼‰**

```bash
# 1. æ„å»ºDocker judgeré•œåƒ
python manage.py build_judger

# 2. é…ç½®ç¯å¢ƒå˜é‡
echo "JUDGE_ENGINE=docker" >> docker.env
echo "SANDBOX_ENABLED=True" >> docker.env

# 3. é‡å¯æœåŠ¡
docker-compose restart web
```

### **å¼€å‘ç¯å¢ƒï¼ˆè¿›ç¨‹æ²™ç®±ï¼‰**

```bash
# é…ç½®ç¯å¢ƒå˜é‡
echo "JUDGE_ENGINE=sandbox" >> docker.env
echo "SANDBOX_ENABLED=True" >> docker.env
```

## ğŸ§ª **å®‰å…¨æµ‹è¯•**

### **è¿è¡Œå®‰å…¨æµ‹è¯•**

```bash
# æµ‹è¯•æ‰€æœ‰åˆ¤é¢˜å¼•æ“
python scripts/test_judge_security.py

# æµ‹è¯•Dockerè¿æ¥
python manage.py shell -c "from judge.docker_engine import DockerJudgeEngine; print(DockerJudgeEngine().test_connection())"
```

### **æµ‹è¯•é¡¹ç›®**

1. **æ¶æ„ä»£ç é˜²æŠ¤**
   - æ–‡ä»¶ç³»ç»Ÿè®¿é—®æµ‹è¯•
   - ç½‘ç»œè®¿é—®æµ‹è¯•
   - ç³»ç»Ÿå‘½ä»¤æ‰§è¡Œæµ‹è¯•
   - æ— é™å¾ªç¯æµ‹è¯•

2. **èµ„æºé™åˆ¶æµ‹è¯•**
   - å†…å­˜æ¶ˆè€—æµ‹è¯•
   - CPUæ¶ˆè€—æµ‹è¯•
   - æ–‡ä»¶å¤§å°é™åˆ¶æµ‹è¯•

3. **éš”ç¦»æ€§æµ‹è¯•**
   - è¿›ç¨‹éš”ç¦»éªŒè¯
   - æ–‡ä»¶ç³»ç»Ÿéš”ç¦»éªŒè¯
   - ç½‘ç»œéš”ç¦»éªŒè¯

## ğŸ“Š **å®‰å…¨çº§åˆ«å¯¹æ¯”**

| å¼•æ“ç±»å‹ | éš”ç¦»çº§åˆ« | å®‰å…¨ç­‰çº§ | æ€§èƒ½ | é€‚ç”¨åœºæ™¯ |
|----------|----------|----------|------|----------|
| **Docker** | å®¹å™¨çº§ | â­â­â­â­â­ | ä¸­ç­‰ | ç”Ÿäº§ç¯å¢ƒ |
| **Sandbox** | è¿›ç¨‹çº§ | â­â­â­â­ | é«˜ | å¼€å‘ç¯å¢ƒ |
| **Basic** | æ— éš”ç¦» | â­â­ | æœ€é«˜ | ä»…å¼€å‘æµ‹è¯• |

## ğŸ”’ **å®‰å…¨ç‰¹æ€§è¯¦è§£**

### **Dockerå®‰å…¨ç‰¹æ€§**

1. **å®¹å™¨éš”ç¦»**
   ```dockerfile
   # éç‰¹æƒç”¨æˆ·
   USER judger
   
   # ç½‘ç»œéš”ç¦»
   network_mode: none
   
   # åªè¯»æ–‡ä»¶ç³»ç»Ÿ
   read_only: true
   
   # èµ„æºé™åˆ¶
   mem_limit: 128m
   cpu_quota: 50000
   ```

2. **å®‰å…¨é…ç½®**
   ```dockerfile
   # å®‰å…¨é€‰é¡¹
   security_opt:
     - no-new-privileges:true
     - seccomp:unconfined
   
   # ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ
   tmpfs:
     /tmp: size=100m,noexec,nosuid,nodev
   ```

### **è¿›ç¨‹æ²™ç®±ç‰¹æ€§**

1. **èµ„æºé™åˆ¶**
   ```python
   # CPUæ—¶é—´é™åˆ¶
   resource.setrlimit(resource.RLIMIT_CPU, (time_limit, time_limit))
   
   # å†…å­˜é™åˆ¶
   resource.setrlimit(resource.RLIMIT_AS, (memory_bytes, memory_bytes))
   
   # æ–‡ä»¶å¤§å°é™åˆ¶
   resource.setrlimit(resource.RLIMIT_FSIZE, (100*1024*1024, 100*1024*1024))
   ```

2. **è¿›ç¨‹ç®¡ç†**
   ```python
   # è¿›ç¨‹ç»„éš”ç¦»
   preexec_fn=os.setsid
   
   # è¶…æ—¶æ§åˆ¶
   process.communicate(timeout=time_limit)
   
   # å¼ºåˆ¶ç»ˆæ­¢
   os.killpg(os.getpgid(process.pid), signal.SIGTERM)
   ```

## ğŸš¨ **å®‰å…¨é£é™©ä¸é˜²æŠ¤**

### **å·²é˜²æŠ¤çš„é£é™©**

1. **ä»£ç æ³¨å…¥** âœ…
   - å®¹å™¨éš”ç¦»é˜²æ­¢ç³»ç»Ÿè®¿é—®
   - è¿›ç¨‹æ²™ç®±é™åˆ¶ç³»ç»Ÿè°ƒç”¨

2. **æ–‡ä»¶ç³»ç»Ÿæ”»å‡»** âœ…
   - åªè¯»æ–‡ä»¶ç³»ç»Ÿä¿æŠ¤
   - ä¸´æ—¶ç›®å½•éš”ç¦»

3. **ç½‘ç»œæ”»å‡»** âœ…
   - ç½‘ç»œå®Œå…¨éš”ç¦»
   - ç¦ç”¨ç½‘ç»œè®¿é—®

4. **èµ„æºæ»¥ç”¨** âœ…
   - ä¸¥æ ¼çš„èµ„æºé™åˆ¶
   - å®æ—¶ç›‘æ§å’Œç»ˆæ­¢

5. **è¿›ç¨‹é€ƒé€¸** âœ…
   - å®¹å™¨çº§éš”ç¦»
   - è¿›ç¨‹ç»„ç®¡ç†

### **æŒç»­ç›‘æ§å»ºè®®**

1. **æ—¥å¿—ç›‘æ§**
   ```bash
   # æŸ¥çœ‹åˆ¤é¢˜æ—¥å¿—
   docker-compose logs -f web | grep "judge"
   ```

2. **èµ„æºç›‘æ§**
   ```bash
   # ç›‘æ§å®¹å™¨èµ„æºä½¿ç”¨
   docker stats django-oj-web
   ```

3. **å®‰å…¨å®¡è®¡**
   ```bash
   # å®šæœŸè¿è¡Œå®‰å…¨æµ‹è¯•
   python scripts/test_judge_security.py
   ```

## ğŸ“ **æœ€ä½³å®è·µ**

### **ç”Ÿäº§ç¯å¢ƒé…ç½®**

1. **ä½¿ç”¨Dockerå¼•æ“**
   ```bash
   JUDGE_ENGINE=docker
   SANDBOX_ENABLED=True
   ```

2. **å®šæœŸæ›´æ–°é•œåƒ**
   ```bash
   docker build -t django-oj-judger:latest ./docker/judger/
   ```

3. **ç›‘æ§å’Œæ—¥å¿—**
   - å¯ç”¨è¯¦ç»†æ—¥å¿—è®°å½•
   - ç›‘æ§èµ„æºä½¿ç”¨æƒ…å†µ
   - å®šæœŸå®‰å…¨å®¡è®¡

### **å¼€å‘ç¯å¢ƒé…ç½®**

1. **ä½¿ç”¨æ²™ç®±å¼•æ“**
   ```bash
   JUDGE_ENGINE=sandbox
   SANDBOX_ENABLED=True
   ```

2. **å®‰å…¨æµ‹è¯•**
   - å®šæœŸè¿è¡Œå®‰å…¨æµ‹è¯•
   - éªŒè¯éš”ç¦»æ•ˆæœ
   - æ£€æŸ¥èµ„æºé™åˆ¶

## ğŸ¯ **æ€»ç»“**

âœ… **åˆ¤é¢˜ç³»ç»Ÿå·²å®ç°å®Œæ•´çš„å®‰å…¨æ²™ç®±**
âœ… **æ”¯æŒDockerå®¹å™¨éš”ç¦»å’Œè¿›ç¨‹çº§æ²™ç®±**
âœ… **æä¾›å¤šç§å®‰å…¨çº§åˆ«é€‰æ‹©**
âœ… **åŒ…å«å®Œæ•´çš„å®‰å…¨æµ‹è¯•å¥—ä»¶**

**æ¨èé…ç½®ï¼š**
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šDockerå¼•æ“ + å®¹å™¨éš”ç¦»
- **å¼€å‘ç¯å¢ƒ**ï¼šSandboxå¼•æ“ + è¿›ç¨‹æ²™ç®±
- **æµ‹è¯•ç¯å¢ƒ**ï¼šBasicå¼•æ“ï¼ˆä»…é™å®‰å…¨æµ‹è¯•ï¼‰

æ‚¨çš„åˆ¤é¢˜ç³»ç»Ÿç°åœ¨å·²ç»å…·å¤‡äº†ä¼ä¸šçº§çš„å®‰å…¨é˜²æŠ¤èƒ½åŠ›ï¼ğŸ›¡ï¸
