{% extends 'base.html' %}

{% block title %}提交代码 - {{ problem.title }}{% endblock %}

{% block extra_css %}
<style>
    .CodeMirror {
        border: 1px solid #ddd;
        border-radius: 4px;
        height: 400px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">提交代码 - {{ problem.title }}</h5>
            </div>
            <div class="card-body">
                <form method="post" id="submitForm">
                    {% csrf_token %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="language" class="form-label">编程语言</label>
                            <select name="language" id="language" class="form-select" required>
                                <option value="python">Python</option>
                                <option value="cpp">C++</option>
                                <option value="c">C</option>
                                <option value="java">Java</option>
                                <option value="javascript">JavaScript</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="templateSelector" class="form-label">代码模板</label>
                            <div class="input-group">
                                <select id="templateSelector" class="form-select">
                                    <option value="">选择模板...</option>
                                </select>
                                <button type="button" class="btn btn-outline-info" id="previewTemplateBtn" disabled>
                                    <i class="fas fa-eye"></i> 预览
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="code" class="form-label">代码</label>
                        <textarea name="code" id="code" class="form-control" rows="20"></textarea>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-info" onclick="insertTemplate()">
                            <i class="fas fa-file-code"></i> 代码模板
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="resetCode()">
                            <i class="fas fa-undo"></i> 重置
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> 提交
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- 题目信息 -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">题目信息</h6>
            </div>
            <div class="card-body">
                <h6>{{ problem.title }}</h6>
                <div class="row text-center">
                    <div class="col-6">
                        <strong>{{ problem.time_limit }}ms</strong><br>
                        <small class="text-muted">时间限制</small>
                    </div>
                    <div class="col-6">
                        <strong>{{ problem.memory_limit }}MB</strong><br>
                        <small class="text-muted">内存限制</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 编辑器设置 -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-cog"></i> 编辑器设置
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="editorTheme" class="form-label">主题</label>
                    <select id="editorTheme" class="form-select form-select-sm">
                        <option value="default">默认</option>
                        <option value="monokai">Monokai</option>
                        <option value="dracula">Dracula</option>
                        <option value="material">Material</option>
                        <option value="solarized light">Solarized Light</option>
                        <option value="solarized dark">Solarized Dark</option>
                        <option value="eclipse">Eclipse</option>
                        <option value="3024-night">3024 Night</option>
                        <option value="midnight">Midnight</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="fontSize" class="form-label">字体大小</label>
                    <select id="fontSize" class="form-select form-select-sm">
                        <option value="12">12px</option>
                        <option value="14" selected>14px</option>
                        <option value="16">16px</option>
                        <option value="18">18px</option>
                        <option value="20">20px</option>
                    </select>
                </div>
                
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="lineWrapping" checked>
                    <label class="form-check-label" for="lineWrapping">
                        自动换行
                    </label>
                </div>
                
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="autoCloseBrackets">
                    <label class="form-check-label" for="autoCloseBrackets">
                        自动闭合括号
                    </label>
                </div>
                
                <div class="d-grid">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="formatCode">
                        <i class="fas fa-magic"></i> 格式化代码
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 样例 -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">样例</h6>
            </div>
            <div class="card-body">
                <h6>输入:</h6>
                <pre class="bg-light p-2 rounded"><code>{{ problem.sample_input }}</code></pre>
                <h6>输出:</h6>
                <pre class="bg-light p-2 rounded"><code>{{ problem.sample_output }}</code></pre>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let editor;
    
    // 模板管理
    let availableTemplates = {};
    let currentTemplates = {};
    const problemId = {{ problem.id }};
    
    // 编辑器设置管理
    const EditorSettings = {
        // 从localStorage加载设置
        load() {
            return {
                theme: localStorage.getItem('editorTheme') || 'default',
                fontSize: localStorage.getItem('editorFontSize') || '14',
                lineWrapping: localStorage.getItem('editorLineWrapping') !== 'false',
                autoCloseBrackets: localStorage.getItem('editorAutoCloseBrackets') === 'true'
            };
        },
        
        // 保存设置到localStorage
        save(settings) {
            localStorage.setItem('editorTheme', settings.theme);
            localStorage.setItem('editorFontSize', settings.fontSize);
            localStorage.setItem('editorLineWrapping', settings.lineWrapping);
            localStorage.setItem('editorAutoCloseBrackets', settings.autoCloseBrackets);
        },
        
        // 应用设置到编辑器
        apply(settings) {
            if (!editor) return;
            
            editor.setOption('theme', settings.theme);
            editor.setOption('lineWrapping', settings.lineWrapping);
            
            // 设置字体大小
            const editorElement = editor.getWrapperElement();
            editorElement.style.fontSize = settings.fontSize + 'px';
            
            // 自动闭合括号需要额外的插件，这里简化处理
            if (settings.autoCloseBrackets) {
                editor.setOption('autoCloseBrackets', true);
            } else {
                editor.setOption('autoCloseBrackets', false);
            }
            
            editor.refresh();
        }
    };
    
    // 代码模板
    const CodeTemplates = {
        python: `# Python 代码模板
def solution():
    # 在这里编写你的代码
    pass

if __name__ == "__main__":
    solution()`,
        cpp: `#include <iostream>
#include <vector>
#include <string>
using namespace std;

int main() {
    // 在这里编写你的代码
    
    return 0;
}`,
        java: `import java.util.*;

public class Main {
    public static void main(String[] args) {
        Scanner scanner = new Scanner(System.in);
        // 在这里编写你的代码
        
        scanner.close();
    }
}`,
        javascript: `// JavaScript 代码模板
const readline = require('readline');

const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
});

rl.on('line', (input) => {
    // 在这里编写你的代码
    
    rl.close();
});`
    };
    
    document.addEventListener('DOMContentLoaded', function() {
        const codeTextarea = document.getElementById('code');
        const languageSelect = document.getElementById('language');
        const templateSelector = document.getElementById('templateSelector');
        const previewBtn = document.getElementById('previewTemplateBtn');
        const form = document.getElementById('submitForm');
        
        // 加载题目模板
        loadProblemTemplates();
        
        // 初始化用户偏好模板
        const currentLanguage = languageSelect.value;
        const preferredTemplate = loadTemplatePreference(currentLanguage);
        if (preferredTemplate) {
            // 延迟加载偏好模板
            setTimeout(() => {
                if (templateSelector.querySelector(`option[value="${preferredTemplate}"]`)) {
                    templateSelector.value = preferredTemplate;
                    previewBtn.disabled = false;
                }
            }, 500);
        }
        
        // 设置控件
        const themeSelect = document.getElementById('editorTheme');
        const fontSizeSelect = document.getElementById('fontSize');
        const lineWrappingCheck = document.getElementById('lineWrapping');
        const autoCloseBracketsCheck = document.getElementById('autoCloseBrackets');
        const formatButton = document.getElementById('formatCode');

        const setEditorMode = (language) => {
            if (!editor) return;
            
            let mode;
            switch(language) {
                case 'python':
                    mode = 'python';
                    break;
                case 'cpp':
                    mode = 'text/x-c++src';
                    break;
                case 'java':
                    mode = 'text/x-java';
                    break;
                case 'javascript':
                    mode = 'javascript';
                    break;
                default:
                    mode = 'python';
            }
            editor.setOption('mode', mode);
        };

        const initCodeMirror = () => {
            try {
                const settings = EditorSettings.load();
                
                editor = CodeMirror.fromTextArea(codeTextarea, {
                    lineNumbers: true,
                    mode: 'python',
                    theme: settings.theme,
                    indentUnit: 4,
                    indentWithTabs: false,
                    lineWrapping: settings.lineWrapping,
                    autoCloseBrackets: settings.autoCloseBrackets
                });
                
                setEditorMode(languageSelect.value);
                EditorSettings.apply(settings);
                return true;
            } catch (error) {
                console.error('CodeMirror 初始化失败，使用 textarea 后备方案:', error);
                editor = null;
                return false;
            }
        };
        
        const loadSettingsToUI = () => {
            const settings = EditorSettings.load();
            themeSelect.value = settings.theme;
            fontSizeSelect.value = settings.fontSize;
            lineWrappingCheck.checked = settings.lineWrapping;
            autoCloseBracketsCheck.checked = settings.autoCloseBrackets;
        };

        if (window.CodeMirror) {
            initCodeMirror();
            loadSettingsToUI();
        } else {
            console.warn('CodeMirror 未加载，使用 textarea 后备方案');
        }

        // 事件监听
        languageSelect.addEventListener('change', function() {
            setEditorMode(this.value);
            // 更新模板选择器
            updateTemplateSelector(this.value);
        });
        
        // 模板选择事件
        templateSelector.addEventListener('change', function() {
            const templateId = this.value;
            previewBtn.disabled = !templateId;
        });
        
        // 模板预览按钮事件
        previewBtn.addEventListener('click', function() {
            const templateId = templateSelector.value;
            if (templateId) {
                previewTemplate(templateId);
            }
        });
        
        // 快捷键支持
        document.addEventListener('keydown', function(e) {
            // Ctrl+T: 快速应用当前选择的模板
            if (e.ctrlKey && e.key === 't') {
                e.preventDefault();
                const templateId = templateSelector.value;
                if (templateId) {
                    applyTemplate(templateId);
                }
            }
            
            // Ctrl+Shift+T: 打开模板选择器
            if (e.ctrlKey && e.shiftKey && e.key === 'T') {
                e.preventDefault();
                templateSelector.focus();
            }
            
            // Ctrl+P: 预览当前选择的模板
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                const templateId = templateSelector.value;
                if (templateId) {
                    previewTemplate(templateId);
                }
            }
        });
        
        // 设置变更监听
        themeSelect.addEventListener('change', function() {
            const settings = EditorSettings.load();
            settings.theme = this.value;
            EditorSettings.save(settings);
            EditorSettings.apply(settings);
        });
        
        fontSizeSelect.addEventListener('change', function() {
            const settings = EditorSettings.load();
            settings.fontSize = this.value;
            EditorSettings.save(settings);
            EditorSettings.apply(settings);
        });
        
        lineWrappingCheck.addEventListener('change', function() {
            const settings = EditorSettings.load();
            settings.lineWrapping = this.checked;
            EditorSettings.save(settings);
            EditorSettings.apply(settings);
        });
        
        autoCloseBracketsCheck.addEventListener('change', function() {
            const settings = EditorSettings.load();
            settings.autoCloseBrackets = this.checked;
            EditorSettings.save(settings);
            EditorSettings.apply(settings);
        });
        
        // 格式化代码按钮
        formatButton.addEventListener('click', function() {
            if (!editor) return;
            
            const cursor = editor.getCursor();
            const language = languageSelect.value;
            
            // 简单的代码格式化（主要是缩进）
            const formatted = formatCode(editor.getValue(), language);
            editor.setValue(formatted);
            editor.setCursor(cursor);
            
            // 显示提示
            this.innerHTML = '<i class="fas fa-check text-success"></i> 已格式化';
            setTimeout(() => {
                this.innerHTML = '<i class="fas fa-magic"></i> 格式化代码';
            }, 2000);
        });

        form.addEventListener('submit', function(e) {
            const codeValue = editor ? editor.getValue() : codeTextarea.value;
            if (!codeValue.trim()) {
                e.preventDefault();
                alert('请输入代码！');
                return false;
            }
            if (editor) {
                codeTextarea.value = codeValue;
            }
            return true;
        });
    });
    
    function resetCode() {
        if (editor) {
            editor.setValue('');
        } else {
            document.getElementById('code').value = '';
        }
    }
    
    function insertTemplate() {
        const language = document.getElementById('language').value;
        const template = CodeTemplates[language] || '';
        
        if (editor) {
            editor.setValue(template);
        } else {
            document.getElementById('code').value = template;
        }
    }
    
    // 简单的代码格式化函数
    function formatCode(code, language) {
        const lines = code.split('\n');
        let indentLevel = 0;
        const indentChar = '    '; // 4个空格
        
        return lines.map(line => {
            const trimmed = line.trim();
            if (!trimmed) return '';
            
            // 减少缩进的情况
            if (language === 'python' && /^(except|elif|else|finally)/.test(trimmed)) {
                indentLevel = Math.max(0, indentLevel - 1);
            } else if (language === 'cpp' || language === 'java' || language === 'javascript') {
                if (trimmed === '}' || trimmed.startsWith('}')) {
                    indentLevel = Math.max(0, indentLevel - 1);
                }
            }
            
            const formatted = indentChar.repeat(indentLevel) + trimmed;
            
            // 增加缩进的情况
            if (language === 'python' && /:$/.test(trimmed)) {
                indentLevel++;
            } else if (language === 'cpp' || language === 'java' || language === 'javascript') {
                if (trimmed.endsWith('{')) {
                    indentLevel++;
                }
            }
            
            return formatted;
        }).join('\n');
    }
    
    // 模板管理函数
    async function loadProblemTemplates() {
        try {
            const response = await fetch(`${problemId}/api/templates/`);
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    availableTemplates = data.templates;
                    // 初始化模板选择器
                    const currentLanguage = document.getElementById('language').value;
                    updateTemplateSelector(currentLanguage);
                }
            } else {
                console.warn('加载模板失败，使用默认模板');
                availableTemplates = {};
            }
        } catch (error) {
            console.error('加载模板时出错:', error);
            availableTemplates = {};
        }
    }
    
    function updateTemplateSelector(language) {
        const templateSelector = document.getElementById('templateSelector');
        const previewBtn = document.getElementById('previewTemplateBtn');
        
        // 清空选项
        templateSelector.innerHTML = '<option value="">选择模板...</option>';
        previewBtn.disabled = true;
        
        // 获取当前语言的模板
        const languageTemplates = getTemplatesForLanguage(language);
        
        // 添加默认选项
        const defaultOption = document.createElement('option');
        defaultOption.value = 'default';
        defaultOption.textContent = `${language.toUpperCase()} 默认模板`;
        defaultOption.dataset.type = 'default';
        templateSelector.appendChild(defaultOption);
        
        if (languageTemplates.length > 0) {
            // 添加分隔符
            const separator = document.createElement('option');
            separator.disabled = true;
            separator.textContent = '─────────────';
            templateSelector.appendChild(separator);
            
            languageTemplates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = template.name;
                option.dataset.type = template.type;
                
                // 为不同类型的模板添加图标前缀
                if (template.type === 'problem') {
                    option.textContent = '📋 ' + template.name;
                } else if (template.type === 'global') {
                    option.textContent = '🌐 ' + template.name;
                }
                
                templateSelector.appendChild(option);
            });
        }
        
        // 自动选择用户偏好的模板
        const preferredTemplate = loadTemplatePreference(language);
        if (preferredTemplate && templateSelector.querySelector(`option[value="${preferredTemplate}"]`)) {
            templateSelector.value = preferredTemplate;
            previewBtn.disabled = false;
        }
    }
    
    function getTemplatesForLanguage(language) {
        const templates = [];
        
        // 添加题目特定模板
        if (availableTemplates[language] && availableTemplates[language].type === 'problem') {
            templates.push({
                id: `problem_${availableTemplates[language].id}`,
                name: `题目专用模板`,
                type: 'problem',
                code: availableTemplates[language].code
            });
        }
        
        // 添加全局模板
        if (availableTemplates[language] && availableTemplates[language].type === 'global') {
            templates.push({
                id: `global_${availableTemplates[language].id}`,
                name: availableTemplates[language].name || `${language.toUpperCase()} 全局模板`,
                type: 'global',
                code: availableTemplates[language].code,
                description: availableTemplates[language].description
            });
        }
        
        return templates;
    }
    
    function previewTemplate(templateId) {
        let templateData = null;
        const language = document.getElementById('language').value;
        
        if (templateId === 'default') {
            // 使用默认模板
            templateData = {
                name: `${language.toUpperCase()} 默认模板`,
                code: CodeTemplates[language] || '',
                description: '系统内置的默认代码模板'
            };
        } else {
            // 查找对应的模板
            const templates = getTemplatesForLanguage(language);
            templateData = templates.find(t => t.id === templateId);
        }
        
        if (templateData) {
            showTemplatePreviewModal(templateData);
        }
    }
    
    function showTemplatePreviewModal(template) {
        const language = document.getElementById('language').value;
        
        // 创建模态框
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.tabIndex = -1;
        modal.innerHTML = `
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-eye"></i> 模板预览 - ${template.name}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${template.description ? `
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> ${template.description}
                            </div>
                        ` : ''}
                        
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="mb-3">
                                    <i class="fas fa-code"></i> 代码内容 
                                    <span class="badge bg-secondary">${language.toUpperCase()}</span>
                                </h6>
                                <div class="code-preview-container">
                                    <textarea id="previewEditor"></textarea>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6 class="mb-3"><i class="fas fa-info"></i> 模板信息</h6>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>类型</span>
                                        <span class="badge ${template.type === 'problem' ? 'bg-primary' : 'bg-success'}">
                                            ${template.type === 'problem' ? '题目专用' : '全局模板'}
                                        </span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>语言</span>
                                        <span>${language.toUpperCase()}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>代码行数</span>
                                        <span>${template.code.split('\\n').length} 行</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>字符数</span>
                                        <span>${template.code.length} 字符</span>
                                    </li>
                                </ul>
                                
                                <div class="mt-3">
                                    <h6><i class="fas fa-keyboard"></i> 快捷键</h6>
                                    <small class="text-muted">
                                        <kbd>Ctrl+T</kbd> 应用模板<br>
                                        <kbd>Ctrl+P</kbd> 预览模板<br>
                                        <kbd>Ctrl+Shift+T</kbd> 打开选择器
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> 取消
                        </button>
                        <button type="button" class="btn btn-success" onclick="applyTemplate('${template.id}')">
                            <i class="fas fa-check"></i> 使用此模板
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        
        // 模态框显示后初始化代码编辑器
        modal.addEventListener('shown.bs.modal', function() {
            const previewTextarea = modal.querySelector('#previewEditor');
            if (previewTextarea && typeof CodeMirror !== 'undefined') {
                const previewEditor = CodeMirror.fromTextArea(previewTextarea, {
                    mode: getLanguageMode(language),
                    theme: EditorSettings.load().theme,
                    readOnly: true,
                    lineNumbers: true,
                    lineWrapping: true,
                    autoCloseBrackets: false,
                    value: template.code
                });
                
                previewEditor.setValue(template.code);
                previewEditor.refresh();
                
                // 存储编辑器实例以便清理
                modal._previewEditor = previewEditor;
            } else {
                // 后备方案：使用普通的 pre 标签
                previewTextarea.style.display = 'none';
                const preContainer = previewTextarea.parentNode;
                preContainer.innerHTML = `<pre class="bg-light p-3 rounded"><code>${template.code}</code></pre>`;
            }
        });
        
        // 模态框关闭后移除元素
        modal.addEventListener('hidden.bs.modal', function() {
            // 清理 CodeMirror 实例
            if (modal._previewEditor) {
                modal._previewEditor.toTextArea();
                delete modal._previewEditor;
            }
            document.body.removeChild(modal);
        });
        
        bsModal.show();
    }
    
    function applyTemplate(templateId) {
        const language = document.getElementById('language').value;
        let templateCode = '';
        
        if (templateId === 'default') {
            templateCode = CodeTemplates[language] || '';
        } else {
            const templates = getTemplatesForLanguage(language);
            const template = templates.find(t => t.id === templateId);
            if (template) {
                templateCode = template.code;
            }
        }
        
        // 应用模板到编辑器
        if (editor) {
            editor.setValue(templateCode);
        } else {
            document.getElementById('code').value = templateCode;
        }
        
        // 关闭所有模态框
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) {
                bsModal.hide();
            }
        });
        
        // 保存用户偏好
        saveTemplatePreference(language, templateId);
    }
    
    function saveTemplatePreference(language, templateId) {
        const preferences = JSON.parse(localStorage.getItem('templatePreferences') || '{}');
        preferences[language] = templateId;
        localStorage.setItem('templatePreferences', JSON.stringify(preferences));
    }
    
    function loadTemplatePreference(language) {
        const preferences = JSON.parse(localStorage.getItem('templatePreferences') || '{}');
        return preferences[language];
    }
</script>
{% endblock %}
