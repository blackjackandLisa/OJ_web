{% extends 'base.html' %}

{% block title %}æäº¤ä»£ç  - {{ problem.title }}{% endblock %}

{% block extra_css %}
<style>
    .CodeMirror {
        border: 1px solid #ddd;
        border-radius: 4px;
        height: 400px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">æäº¤ä»£ç  - {{ problem.title }}</h5>
            </div>
            <div class="card-body">
                <form method="post" id="submitForm">
                    {% csrf_token %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="language" class="form-label">ç¼–ç¨‹è¯­è¨€</label>
                            <select name="language" id="language" class="form-select" required>
                                <option value="python">Python</option>
                                <option value="cpp">C++</option>
                                <option value="c">C</option>
                                <option value="java">Java</option>
                                <option value="javascript">JavaScript</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="templateSelector" class="form-label">ä»£ç æ¨¡æ¿</label>
                            <div class="input-group">
                                <select id="templateSelector" class="form-select">
                                    <option value="">é€‰æ‹©æ¨¡æ¿...</option>
                                </select>
                                <button type="button" class="btn btn-outline-info" id="previewTemplateBtn" disabled>
                                    <i class="fas fa-eye"></i> é¢„è§ˆ
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="code" class="form-label">ä»£ç </label>
                        <textarea name="code" id="code" class="form-control" rows="20"></textarea>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-info" onclick="insertTemplate()">
                            <i class="fas fa-file-code"></i> ä»£ç æ¨¡æ¿
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="resetCode()">
                            <i class="fas fa-undo"></i> é‡ç½®
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> æäº¤
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- é¢˜ç›®ä¿¡æ¯ -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">é¢˜ç›®ä¿¡æ¯</h6>
            </div>
            <div class="card-body">
                <h6>{{ problem.title }}</h6>
                <div class="row text-center">
                    <div class="col-6">
                        <strong>{{ problem.time_limit }}ms</strong><br>
                        <small class="text-muted">æ—¶é—´é™åˆ¶</small>
                    </div>
                    <div class="col-6">
                        <strong>{{ problem.memory_limit }}MB</strong><br>
                        <small class="text-muted">å†…å­˜é™åˆ¶</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç¼–è¾‘å™¨è®¾ç½® -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-cog"></i> ç¼–è¾‘å™¨è®¾ç½®
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="editorTheme" class="form-label">ä¸»é¢˜</label>
                    <select id="editorTheme" class="form-select form-select-sm">
                        <option value="default">é»˜è®¤</option>
                        <option value="monokai">Monokai</option>
                        <option value="dracula">Dracula</option>
                        <option value="material">Material</option>
                        <option value="solarized light">Solarized Light</option>
                        <option value="solarized dark">Solarized Dark</option>
                        <option value="eclipse">Eclipse</option>
                        <option value="3024-night">3024 Night</option>
                        <option value="midnight">Midnight</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="fontSize" class="form-label">å­—ä½“å¤§å°</label>
                    <select id="fontSize" class="form-select form-select-sm">
                        <option value="12">12px</option>
                        <option value="14" selected>14px</option>
                        <option value="16">16px</option>
                        <option value="18">18px</option>
                        <option value="20">20px</option>
                    </select>
                </div>
                
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="lineWrapping" checked>
                    <label class="form-check-label" for="lineWrapping">
                        è‡ªåŠ¨æ¢è¡Œ
                    </label>
                </div>
                
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="autoCloseBrackets">
                    <label class="form-check-label" for="autoCloseBrackets">
                        è‡ªåŠ¨é—­åˆæ‹¬å·
                    </label>
                </div>
                
                <div class="d-grid">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="formatCode">
                        <i class="fas fa-magic"></i> æ ¼å¼åŒ–ä»£ç 
                    </button>
                </div>
            </div>
        </div>
        
        <!-- æ ·ä¾‹ -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">æ ·ä¾‹</h6>
            </div>
            <div class="card-body">
                <h6>è¾“å…¥:</h6>
                <pre class="bg-light p-2 rounded"><code>{{ problem.sample_input }}</code></pre>
                <h6>è¾“å‡º:</h6>
                <pre class="bg-light p-2 rounded"><code>{{ problem.sample_output }}</code></pre>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let editor;
    
    // æ¨¡æ¿ç®¡ç†
    let availableTemplates = {};
    let currentTemplates = {};
    const problemId = {{ problem.id }};
    
    // ç¼–è¾‘å™¨è®¾ç½®ç®¡ç†
    const EditorSettings = {
        // ä»localStorageåŠ è½½è®¾ç½®
        load() {
            return {
                theme: localStorage.getItem('editorTheme') || 'default',
                fontSize: localStorage.getItem('editorFontSize') || '14',
                lineWrapping: localStorage.getItem('editorLineWrapping') !== 'false',
                autoCloseBrackets: localStorage.getItem('editorAutoCloseBrackets') === 'true'
            };
        },
        
        // ä¿å­˜è®¾ç½®åˆ°localStorage
        save(settings) {
            localStorage.setItem('editorTheme', settings.theme);
            localStorage.setItem('editorFontSize', settings.fontSize);
            localStorage.setItem('editorLineWrapping', settings.lineWrapping);
            localStorage.setItem('editorAutoCloseBrackets', settings.autoCloseBrackets);
        },
        
        // åº”ç”¨è®¾ç½®åˆ°ç¼–è¾‘å™¨
        apply(settings) {
            if (!editor) return;
            
            editor.setOption('theme', settings.theme);
            editor.setOption('lineWrapping', settings.lineWrapping);
            
            // è®¾ç½®å­—ä½“å¤§å°
            const editorElement = editor.getWrapperElement();
            editorElement.style.fontSize = settings.fontSize + 'px';
            
            // è‡ªåŠ¨é—­åˆæ‹¬å·éœ€è¦é¢å¤–çš„æ’ä»¶ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
            if (settings.autoCloseBrackets) {
                editor.setOption('autoCloseBrackets', true);
            } else {
                editor.setOption('autoCloseBrackets', false);
            }
            
            editor.refresh();
        }
    };
    
    // ä»£ç æ¨¡æ¿
    const CodeTemplates = {
        python: `# Python ä»£ç æ¨¡æ¿
def solution():
    # åœ¨è¿™é‡Œç¼–å†™ä½ çš„ä»£ç 
    pass

if __name__ == "__main__":
    solution()`,
        cpp: `#include <iostream>
#include <vector>
#include <string>
using namespace std;

int main() {
    // åœ¨è¿™é‡Œç¼–å†™ä½ çš„ä»£ç 
    
    return 0;
}`,
        java: `import java.util.*;

public class Main {
    public static void main(String[] args) {
        Scanner scanner = new Scanner(System.in);
        // åœ¨è¿™é‡Œç¼–å†™ä½ çš„ä»£ç 
        
        scanner.close();
    }
}`,
        javascript: `// JavaScript ä»£ç æ¨¡æ¿
const readline = require('readline');

const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
});

rl.on('line', (input) => {
    // åœ¨è¿™é‡Œç¼–å†™ä½ çš„ä»£ç 
    
    rl.close();
});`
    };
    
    document.addEventListener('DOMContentLoaded', function() {
        const codeTextarea = document.getElementById('code');
        const languageSelect = document.getElementById('language');
        const templateSelector = document.getElementById('templateSelector');
        const previewBtn = document.getElementById('previewTemplateBtn');
        const form = document.getElementById('submitForm');
        
        // åŠ è½½é¢˜ç›®æ¨¡æ¿
        loadProblemTemplates();
        
        // åˆå§‹åŒ–ç”¨æˆ·åå¥½æ¨¡æ¿
        const currentLanguage = languageSelect.value;
        const preferredTemplate = loadTemplatePreference(currentLanguage);
        if (preferredTemplate) {
            // å»¶è¿ŸåŠ è½½åå¥½æ¨¡æ¿
            setTimeout(() => {
                if (templateSelector.querySelector(`option[value="${preferredTemplate}"]`)) {
                    templateSelector.value = preferredTemplate;
                    previewBtn.disabled = false;
                }
            }, 500);
        }
        
        // è®¾ç½®æ§ä»¶
        const themeSelect = document.getElementById('editorTheme');
        const fontSizeSelect = document.getElementById('fontSize');
        const lineWrappingCheck = document.getElementById('lineWrapping');
        const autoCloseBracketsCheck = document.getElementById('autoCloseBrackets');
        const formatButton = document.getElementById('formatCode');

        const setEditorMode = (language) => {
            if (!editor) return;
            
            let mode;
            switch(language) {
                case 'python':
                    mode = 'python';
                    break;
                case 'cpp':
                    mode = 'text/x-c++src';
                    break;
                case 'java':
                    mode = 'text/x-java';
                    break;
                case 'javascript':
                    mode = 'javascript';
                    break;
                default:
                    mode = 'python';
            }
            editor.setOption('mode', mode);
        };

        const initCodeMirror = () => {
            try {
                const settings = EditorSettings.load();
                
                editor = CodeMirror.fromTextArea(codeTextarea, {
                    lineNumbers: true,
                    mode: 'python',
                    theme: settings.theme,
                    indentUnit: 4,
                    indentWithTabs: false,
                    lineWrapping: settings.lineWrapping,
                    autoCloseBrackets: settings.autoCloseBrackets
                });
                
                setEditorMode(languageSelect.value);
                EditorSettings.apply(settings);
                return true;
            } catch (error) {
                console.error('CodeMirror åˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨ textarea åå¤‡æ–¹æ¡ˆ:', error);
                editor = null;
                return false;
            }
        };
        
        const loadSettingsToUI = () => {
            const settings = EditorSettings.load();
            themeSelect.value = settings.theme;
            fontSizeSelect.value = settings.fontSize;
            lineWrappingCheck.checked = settings.lineWrapping;
            autoCloseBracketsCheck.checked = settings.autoCloseBrackets;
        };

        if (window.CodeMirror) {
            initCodeMirror();
            loadSettingsToUI();
        } else {
            console.warn('CodeMirror æœªåŠ è½½ï¼Œä½¿ç”¨ textarea åå¤‡æ–¹æ¡ˆ');
        }

        // äº‹ä»¶ç›‘å¬
        languageSelect.addEventListener('change', function() {
            setEditorMode(this.value);
            // æ›´æ–°æ¨¡æ¿é€‰æ‹©å™¨
            updateTemplateSelector(this.value);
        });
        
        // æ¨¡æ¿é€‰æ‹©äº‹ä»¶
        templateSelector.addEventListener('change', function() {
            const templateId = this.value;
            previewBtn.disabled = !templateId;
        });
        
        // æ¨¡æ¿é¢„è§ˆæŒ‰é’®äº‹ä»¶
        previewBtn.addEventListener('click', function() {
            const templateId = templateSelector.value;
            if (templateId) {
                previewTemplate(templateId);
            }
        });
        
        // å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', function(e) {
            // Ctrl+T: å¿«é€Ÿåº”ç”¨å½“å‰é€‰æ‹©çš„æ¨¡æ¿
            if (e.ctrlKey && e.key === 't') {
                e.preventDefault();
                const templateId = templateSelector.value;
                if (templateId) {
                    applyTemplate(templateId);
                }
            }
            
            // Ctrl+Shift+T: æ‰“å¼€æ¨¡æ¿é€‰æ‹©å™¨
            if (e.ctrlKey && e.shiftKey && e.key === 'T') {
                e.preventDefault();
                templateSelector.focus();
            }
            
            // Ctrl+P: é¢„è§ˆå½“å‰é€‰æ‹©çš„æ¨¡æ¿
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                const templateId = templateSelector.value;
                if (templateId) {
                    previewTemplate(templateId);
                }
            }
        });
        
        // è®¾ç½®å˜æ›´ç›‘å¬
        themeSelect.addEventListener('change', function() {
            const settings = EditorSettings.load();
            settings.theme = this.value;
            EditorSettings.save(settings);
            EditorSettings.apply(settings);
        });
        
        fontSizeSelect.addEventListener('change', function() {
            const settings = EditorSettings.load();
            settings.fontSize = this.value;
            EditorSettings.save(settings);
            EditorSettings.apply(settings);
        });
        
        lineWrappingCheck.addEventListener('change', function() {
            const settings = EditorSettings.load();
            settings.lineWrapping = this.checked;
            EditorSettings.save(settings);
            EditorSettings.apply(settings);
        });
        
        autoCloseBracketsCheck.addEventListener('change', function() {
            const settings = EditorSettings.load();
            settings.autoCloseBrackets = this.checked;
            EditorSettings.save(settings);
            EditorSettings.apply(settings);
        });
        
        // æ ¼å¼åŒ–ä»£ç æŒ‰é’®
        formatButton.addEventListener('click', function() {
            if (!editor) return;
            
            const cursor = editor.getCursor();
            const language = languageSelect.value;
            
            // ç®€å•çš„ä»£ç æ ¼å¼åŒ–ï¼ˆä¸»è¦æ˜¯ç¼©è¿›ï¼‰
            const formatted = formatCode(editor.getValue(), language);
            editor.setValue(formatted);
            editor.setCursor(cursor);
            
            // æ˜¾ç¤ºæç¤º
            this.innerHTML = '<i class="fas fa-check text-success"></i> å·²æ ¼å¼åŒ–';
            setTimeout(() => {
                this.innerHTML = '<i class="fas fa-magic"></i> æ ¼å¼åŒ–ä»£ç ';
            }, 2000);
        });

        form.addEventListener('submit', function(e) {
            const codeValue = editor ? editor.getValue() : codeTextarea.value;
            if (!codeValue.trim()) {
                e.preventDefault();
                alert('è¯·è¾“å…¥ä»£ç ï¼');
                return false;
            }
            if (editor) {
                codeTextarea.value = codeValue;
            }
            return true;
        });
    });
    
    function resetCode() {
        if (editor) {
            editor.setValue('');
        } else {
            document.getElementById('code').value = '';
        }
    }
    
    function insertTemplate() {
        const language = document.getElementById('language').value;
        const template = CodeTemplates[language] || '';
        
        if (editor) {
            editor.setValue(template);
        } else {
            document.getElementById('code').value = template;
        }
    }
    
    // ç®€å•çš„ä»£ç æ ¼å¼åŒ–å‡½æ•°
    function formatCode(code, language) {
        const lines = code.split('\n');
        let indentLevel = 0;
        const indentChar = '    '; // 4ä¸ªç©ºæ ¼
        
        return lines.map(line => {
            const trimmed = line.trim();
            if (!trimmed) return '';
            
            // å‡å°‘ç¼©è¿›çš„æƒ…å†µ
            if (language === 'python' && /^(except|elif|else|finally)/.test(trimmed)) {
                indentLevel = Math.max(0, indentLevel - 1);
            } else if (language === 'cpp' || language === 'java' || language === 'javascript') {
                if (trimmed === '}' || trimmed.startsWith('}')) {
                    indentLevel = Math.max(0, indentLevel - 1);
                }
            }
            
            const formatted = indentChar.repeat(indentLevel) + trimmed;
            
            // å¢åŠ ç¼©è¿›çš„æƒ…å†µ
            if (language === 'python' && /:$/.test(trimmed)) {
                indentLevel++;
            } else if (language === 'cpp' || language === 'java' || language === 'javascript') {
                if (trimmed.endsWith('{')) {
                    indentLevel++;
                }
            }
            
            return formatted;
        }).join('\n');
    }
    
    // æ¨¡æ¿ç®¡ç†å‡½æ•°
    async function loadProblemTemplates() {
        try {
            const response = await fetch(`${problemId}/api/templates/`);
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    availableTemplates = data.templates;
                    // åˆå§‹åŒ–æ¨¡æ¿é€‰æ‹©å™¨
                    const currentLanguage = document.getElementById('language').value;
                    updateTemplateSelector(currentLanguage);
                }
            } else {
                console.warn('åŠ è½½æ¨¡æ¿å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ¨¡æ¿');
                availableTemplates = {};
            }
        } catch (error) {
            console.error('åŠ è½½æ¨¡æ¿æ—¶å‡ºé”™:', error);
            availableTemplates = {};
        }
    }
    
    function updateTemplateSelector(language) {
        const templateSelector = document.getElementById('templateSelector');
        const previewBtn = document.getElementById('previewTemplateBtn');
        
        // æ¸…ç©ºé€‰é¡¹
        templateSelector.innerHTML = '<option value="">é€‰æ‹©æ¨¡æ¿...</option>';
        previewBtn.disabled = true;
        
        // è·å–å½“å‰è¯­è¨€çš„æ¨¡æ¿
        const languageTemplates = getTemplatesForLanguage(language);
        
        // æ·»åŠ é»˜è®¤é€‰é¡¹
        const defaultOption = document.createElement('option');
        defaultOption.value = 'default';
        defaultOption.textContent = `${language.toUpperCase()} é»˜è®¤æ¨¡æ¿`;
        defaultOption.dataset.type = 'default';
        templateSelector.appendChild(defaultOption);
        
        if (languageTemplates.length > 0) {
            // æ·»åŠ åˆ†éš”ç¬¦
            const separator = document.createElement('option');
            separator.disabled = true;
            separator.textContent = 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€';
            templateSelector.appendChild(separator);
            
            languageTemplates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = template.name;
                option.dataset.type = template.type;
                
                // ä¸ºä¸åŒç±»å‹çš„æ¨¡æ¿æ·»åŠ å›¾æ ‡å‰ç¼€
                if (template.type === 'problem') {
                    option.textContent = 'ğŸ“‹ ' + template.name;
                } else if (template.type === 'global') {
                    option.textContent = 'ğŸŒ ' + template.name;
                }
                
                templateSelector.appendChild(option);
            });
        }
        
        // è‡ªåŠ¨é€‰æ‹©ç”¨æˆ·åå¥½çš„æ¨¡æ¿
        const preferredTemplate = loadTemplatePreference(language);
        if (preferredTemplate && templateSelector.querySelector(`option[value="${preferredTemplate}"]`)) {
            templateSelector.value = preferredTemplate;
            previewBtn.disabled = false;
        }
    }
    
    function getTemplatesForLanguage(language) {
        const templates = [];
        
        // æ·»åŠ é¢˜ç›®ç‰¹å®šæ¨¡æ¿
        if (availableTemplates[language] && availableTemplates[language].type === 'problem') {
            templates.push({
                id: `problem_${availableTemplates[language].id}`,
                name: `é¢˜ç›®ä¸“ç”¨æ¨¡æ¿`,
                type: 'problem',
                code: availableTemplates[language].code
            });
        }
        
        // æ·»åŠ å…¨å±€æ¨¡æ¿
        if (availableTemplates[language] && availableTemplates[language].type === 'global') {
            templates.push({
                id: `global_${availableTemplates[language].id}`,
                name: availableTemplates[language].name || `${language.toUpperCase()} å…¨å±€æ¨¡æ¿`,
                type: 'global',
                code: availableTemplates[language].code,
                description: availableTemplates[language].description
            });
        }
        
        return templates;
    }
    
    function previewTemplate(templateId) {
        let templateData = null;
        const language = document.getElementById('language').value;
        
        if (templateId === 'default') {
            // ä½¿ç”¨é»˜è®¤æ¨¡æ¿
            templateData = {
                name: `${language.toUpperCase()} é»˜è®¤æ¨¡æ¿`,
                code: CodeTemplates[language] || '',
                description: 'ç³»ç»Ÿå†…ç½®çš„é»˜è®¤ä»£ç æ¨¡æ¿'
            };
        } else {
            // æŸ¥æ‰¾å¯¹åº”çš„æ¨¡æ¿
            const templates = getTemplatesForLanguage(language);
            templateData = templates.find(t => t.id === templateId);
        }
        
        if (templateData) {
            showTemplatePreviewModal(templateData);
        }
    }
    
    function showTemplatePreviewModal(template) {
        const language = document.getElementById('language').value;
        
        // åˆ›å»ºæ¨¡æ€æ¡†
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.tabIndex = -1;
        modal.innerHTML = `
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-eye"></i> æ¨¡æ¿é¢„è§ˆ - ${template.name}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${template.description ? `
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> ${template.description}
                            </div>
                        ` : ''}
                        
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="mb-3">
                                    <i class="fas fa-code"></i> ä»£ç å†…å®¹ 
                                    <span class="badge bg-secondary">${language.toUpperCase()}</span>
                                </h6>
                                <div class="code-preview-container">
                                    <textarea id="previewEditor"></textarea>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6 class="mb-3"><i class="fas fa-info"></i> æ¨¡æ¿ä¿¡æ¯</h6>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>ç±»å‹</span>
                                        <span class="badge ${template.type === 'problem' ? 'bg-primary' : 'bg-success'}">
                                            ${template.type === 'problem' ? 'é¢˜ç›®ä¸“ç”¨' : 'å…¨å±€æ¨¡æ¿'}
                                        </span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>è¯­è¨€</span>
                                        <span>${language.toUpperCase()}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>ä»£ç è¡Œæ•°</span>
                                        <span>${template.code.split('\\n').length} è¡Œ</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>å­—ç¬¦æ•°</span>
                                        <span>${template.code.length} å­—ç¬¦</span>
                                    </li>
                                </ul>
                                
                                <div class="mt-3">
                                    <h6><i class="fas fa-keyboard"></i> å¿«æ·é”®</h6>
                                    <small class="text-muted">
                                        <kbd>Ctrl+T</kbd> åº”ç”¨æ¨¡æ¿<br>
                                        <kbd>Ctrl+P</kbd> é¢„è§ˆæ¨¡æ¿<br>
                                        <kbd>Ctrl+Shift+T</kbd> æ‰“å¼€é€‰æ‹©å™¨
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> å–æ¶ˆ
                        </button>
                        <button type="button" class="btn btn-success" onclick="applyTemplate('${template.id}')">
                            <i class="fas fa-check"></i> ä½¿ç”¨æ­¤æ¨¡æ¿
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        
        // æ¨¡æ€æ¡†æ˜¾ç¤ºååˆå§‹åŒ–ä»£ç ç¼–è¾‘å™¨
        modal.addEventListener('shown.bs.modal', function() {
            const previewTextarea = modal.querySelector('#previewEditor');
            if (previewTextarea && typeof CodeMirror !== 'undefined') {
                const previewEditor = CodeMirror.fromTextArea(previewTextarea, {
                    mode: getLanguageMode(language),
                    theme: EditorSettings.load().theme,
                    readOnly: true,
                    lineNumbers: true,
                    lineWrapping: true,
                    autoCloseBrackets: false,
                    value: template.code
                });
                
                previewEditor.setValue(template.code);
                previewEditor.refresh();
                
                // å­˜å‚¨ç¼–è¾‘å™¨å®ä¾‹ä»¥ä¾¿æ¸…ç†
                modal._previewEditor = previewEditor;
            } else {
                // åå¤‡æ–¹æ¡ˆï¼šä½¿ç”¨æ™®é€šçš„ pre æ ‡ç­¾
                previewTextarea.style.display = 'none';
                const preContainer = previewTextarea.parentNode;
                preContainer.innerHTML = `<pre class="bg-light p-3 rounded"><code>${template.code}</code></pre>`;
            }
        });
        
        // æ¨¡æ€æ¡†å…³é—­åç§»é™¤å…ƒç´ 
        modal.addEventListener('hidden.bs.modal', function() {
            // æ¸…ç† CodeMirror å®ä¾‹
            if (modal._previewEditor) {
                modal._previewEditor.toTextArea();
                delete modal._previewEditor;
            }
            document.body.removeChild(modal);
        });
        
        bsModal.show();
    }
    
    function applyTemplate(templateId) {
        const language = document.getElementById('language').value;
        let templateCode = '';
        
        if (templateId === 'default') {
            templateCode = CodeTemplates[language] || '';
        } else {
            const templates = getTemplatesForLanguage(language);
            const template = templates.find(t => t.id === templateId);
            if (template) {
                templateCode = template.code;
            }
        }
        
        // åº”ç”¨æ¨¡æ¿åˆ°ç¼–è¾‘å™¨
        if (editor) {
            editor.setValue(templateCode);
        } else {
            document.getElementById('code').value = templateCode;
        }
        
        // å…³é—­æ‰€æœ‰æ¨¡æ€æ¡†
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) {
                bsModal.hide();
            }
        });
        
        // ä¿å­˜ç”¨æˆ·åå¥½
        saveTemplatePreference(language, templateId);
    }
    
    function saveTemplatePreference(language, templateId) {
        const preferences = JSON.parse(localStorage.getItem('templatePreferences') || '{}');
        preferences[language] = templateId;
        localStorage.setItem('templatePreferences', JSON.stringify(preferences));
    }
    
    function loadTemplatePreference(language) {
        const preferences = JSON.parse(localStorage.getItem('templatePreferences') || '{}');
        return preferences[language];
    }
</script>
{% endblock %}
